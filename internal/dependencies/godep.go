package dependencies

import (
	"encoding/json"
	"io/ioutil"
	"runtime"
	"sort"
	"strings"
)

type Godeps struct {
	Comment      string `json:"_Comment"`
	ImportPath   string
	GoVersion    string
	GodepVersion string
	Packages     []string
	Deps         []Dependency
}

type Dependency struct {
	ImportPath string
	Comment    string `json:",omitempty"`
	Rev        string
}

func (gd Godeps) DumpToFile(fname string) error {
	gd.Comment = "GENERATED BY DEP, DO NOT EDIT"
	gd.Packages = append(gd.Packages, "./...")
	gd.GoVersion = getVersion()
	gd.GodepVersion = "v80"

	sort.Slice(gd.Deps, func(i, j int) bool {
		return strings.Compare(gd.Deps[i].ImportPath, gd.Deps[j].ImportPath) < 0
	})

	js, err := json.MarshalIndent(gd, "", "\t")
	if err != nil {
		return err
	}
	err = ioutil.WriteFile(fname, js, 0644)
	return err
}

func getVersion() string {
	v := runtime.Version()
	p := strings.Split(v, ".")
	return p[0] + "." + p[1]
}
